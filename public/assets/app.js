// Main frontend script: loads products, cart, theme, logo injection
async function fetchProducts(){ const res = await fetch('/api/products'); if(!res.ok) return []; return await res.json(); }
function injectLogo(){ const el = document.querySelector('.logo'); if(!el) return; el.innerHTML = `<svg viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg"><defs><linearGradient id="g" x1="0" x2="1"><stop offset="0" stop-color="#8b5cf6"/><stop offset="1" stop-color="#6ec1ff"/></linearGradient></defs><rect x="4" y="4" width="56" height="56" rx="12" fill="url(#g)"></rect><text x="32" y="40" font-size="24" text-anchor="middle" fill="#fff" font-weight="700">S</text></svg><span>SellLite</span>`; }
function money(cents){ return (cents/100).toLocaleString('fr-FR',{style:'currency',currency:'EUR'}) }

async function renderProducts(){ const root = document.getElementById('products'); if(!root) return; const products = await fetchProducts(); root.innerHTML = products.map(p=>`<div class="card"><h3>${p.title}</h3><p>${p.description||''}</p><div class="price">${money(p.price_cents)}</div><div style="margin-top:10px"><button class="btn buy" data-id="${p.id}">Acheter</button> <a class="btn" href="/product.html?id=${p.id}">Détails</a></div></div>`).join(''); document.querySelectorAll('.buy').forEach(b=>b.addEventListener('click', onBuy)); }

async function renderProductDetail(){ const root = document.getElementById('product-detail'); if(!root) return; const params = new URLSearchParams(location.search); const id = Number(params.get('id')); if(!id) return; const res = await fetch('/api/products/'+id); if(!res.ok){ root.innerHTML='<p>Produit introuvable</p>'; return; } const p = await res.json(); root.innerHTML = `<h2>${p.title}</h2><p>${p.description||''}</p><div class="price">${money(p.price_cents)}</div><div style="margin-top:12px"><button id="buy" class="btn" data-id="${p.id}">Ajouter au panier</button></div>`; document.getElementById('buy').addEventListener('click', async ()=>{ await fetch('/api/cart/add',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({productId:p.id,qty:1})}); alert('Ajouté au panier'); window.location='/cart.html'; }); }

async function renderCart(){ const root = document.getElementById('cart'); if(!root) return; const res = await fetch('/api/cart'); const cart = await res.json(); if(!cart.items || cart.items.length===0){ root.innerHTML='<p>Panier vide</p>'; return; } root.innerHTML = cart.items.map(i=>`<div class="card"><h3>${i.title}</h3><div>Qté: ${i.qty}</div><div class="price">${money(i.price_cents*i.qty)}</div><div style="margin-top:10px"><button class="btn checkout" data-id="${i.productId}">Payer</button> <button class="btn" data-id="${i.productId}" id="remove-${i.productId}">Suppr</button></div></div>`).join(''); cart.items.forEach(i=>{ document.getElementById('remove-'+i.productId).addEventListener('click', async ()=>{ await fetch('/api/cart/remove',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({productId:i.productId})}); renderCart(); }); }); document.querySelectorAll('.checkout').forEach(b=>b.addEventListener('click', async e=>{ const pid = Number(e.currentTarget.dataset.id); const email = prompt('Email de livraison:','client@exemple.test'); if(!email) return; const res = await fetch('/api/payments/create-checkout-session',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({productId:pid,email,qty:1})}); const data = await res.json(); if(data.orderId) window.location='/checkout-success.html?orderId='+data.orderId; else alert('Erreur'); })); }

document.addEventListener('DOMContentLoaded', ()=>{ injectLogo(); renderProducts(); renderProductDetail(); renderCart(); });
