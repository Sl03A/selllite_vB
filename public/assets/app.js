function money(cents){ return (cents/100).toLocaleString('fr-FR',{style:'currency',currency:'EUR'}) }

async function fetchProducts(){ const res = await fetch('/api/products'); if(!res.ok) return []; return res.json(); }

async function renderProducts(){ const root = document.getElementById('products'); if(!root) return; const products = await fetchProducts(); if(!products.length){ root.innerHTML='<p>Aucun produit.</p>'; return;} root.innerHTML = products.map(p=>`<div class="card"><img src="${p.image_url||'/uploads/default.png'}" class="thumb"/><h3>${p.title}</h3><p>${p.description||''}</p><div class="price">${money(p.price_cents)}</div><div style="margin-top:8px"><button class="btn add" data-id="${p.id}">Ajouter au panier</button> <a class="btn" href="/product.html?id=${p.id}">Détails</a></div></div>`).join(''); document.querySelectorAll('.add').forEach(b=>b.addEventListener('click', onAdd)); }

async function onAdd(e){ const id = Number(e.currentTarget.dataset.id); const res = await fetch('/api/cart/add',{method:'POST',headers:{'Content-Type':'application/json'},body: JSON.stringify({product_id: id, qty:1})}); if(res.ok){ alert('Ajouté au panier'); window.location='/cart.html'; } else { const j = await res.json(); alert('Erreur: '+(j.error||'')); } }

async function renderProductDetail(){ const root = document.getElementById('product-detail'); if(!root) return; const q = new URLSearchParams(location.search); const id = q.get('id'); if(!id) return; const res = await fetch('/api/products/'+id); if(!res.ok){ root.innerHTML='Produit introuvable'; return;} const p = await res.json(); root.innerHTML = `<h2>${p.title}</h2><img src="${p.image_url||'/uploads/default.png'}" class="detail"/><p>${p.description||''}</p><div class="price">${money(p.price_cents)}</div><div style="margin-top:12px"><button id="add-to-cart">Ajouter au panier</button></div>`; document.getElementById('add-to-cart').addEventListener('click', ()=>fetch('/api/cart/add',{method:'POST',headers:{'Content-Type':'application/json'},body: JSON.stringify({product_id: p.id, qty:1})}).then(r=>{ if(r.ok) window.location='/cart.html'; else alert('Erreur'); })); }

async function renderCart(){ const root = document.getElementById('cart'); if(!root) return; const res = await fetch('/api/cart'); if(!res.ok) return; const cart = await res.json(); if(!cart.items || cart.items.length===0){ root.innerHTML='<p>Panier vide</p>'; return; } root.innerHTML = cart.items.map(i=>`<div class="card"><h3>${i.title}</h3><div>Qté: ${i.qty}</div><div class="price">${money(i.price_cents*i.qty)}</div><div style="margin-top:10px"><button class="btn pay" data-id="${i.productId}" data-qty="${i.qty}">Payer</button> <button class="btn remove" data-id="${i.productId}">Suppr</button></div></div>`).join(''); document.querySelectorAll('.remove').forEach(b=>b.addEventListener('click', async e=>{ const id=Number(e.currentTarget.dataset.id); await fetch('/api/cart/remove',{method:'POST',headers:{'Content-Type':'application/json'},body: JSON.stringify({productId:id})}); renderCart(); })); document.querySelectorAll('.pay').forEach(b=>b.addEventListener('click', async e=>{ const pid=Number(e.currentTarget.dataset.id); const qty=Number(e.currentTarget.dataset.qty)||1; const email = prompt('Email de facturation:','client@example.test'); if(!email) return; const res = await fetch('/api/payments/create-checkout-session',{method:'POST',headers:{'Content-Type':'application/json'},body: JSON.stringify({productId:pid,qty:qty,email})}); const j = await res.json(); if(j.orderId) { alert('Paiement simulé, commande: '+j.orderId); await fetch('/api/cart/clear',{method:'POST'}); window.location='/products.html'; } else alert('Erreur: '+(j.error||'')); })); }

document.addEventListener('DOMContentLoaded', ()=>{ renderProducts(); renderProductDetail(); renderCart(); });
